<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Claude-Saver Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3345;
    --text: #e1e4ed;
    --text-dim: #8b90a5;
    --accent: #6c5ce7;
    --green: #00b894;
    --red: #e17055;
    --orange: #fdcb6e;
    --blue: #74b9ff;
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }

  .header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .header h1 {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }

  .header h1 span { color: var(--accent); }

  .header-meta {
    display: flex;
    gap: 16px;
    align-items: center;
    font-size: 13px;
    color: var(--text-dim);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }
  .status-dot.live { background: var(--green); }
  .status-dot.off { background: var(--red); }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 32px;
  }

  /* KPI Cards */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .kpi {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .kpi-label {
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .kpi-value {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -1px;
  }

  .kpi-value.positive { color: var(--green); }
  .kpi-value.negative { color: var(--red); }
  .kpi-value.neutral { color: var(--blue); }
  .kpi-value.warn { color: var(--orange); }

  .kpi-sub {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  /* Charts */
  .chart-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .chart-full {
    margin-bottom: 24px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text);
  }

  .chart-container {
    position: relative;
    height: 260px;
  }

  .chart-container.tall {
    height: 300px;
  }

  /* Table */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  th {
    text-align: left;
    padding: 10px 12px;
    font-weight: 500;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }

  tr:last-child td { border-bottom: none; }

  .tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
  }

  .tag-tool { background: rgba(108, 92, 231, 0.15); color: var(--accent); }
  .tag-model { background: rgba(116, 185, 255, 0.15); color: var(--blue); }

  .positive-cell { color: var(--green); }
  .negative-cell { color: var(--red); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
  }

  .empty-state h2 {
    font-size: 18px;
    margin-bottom: 8px;
    color: var(--text);
  }

  /* Privacy badge */
  .privacy-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 6px;
    background: rgba(0, 184, 148, 0.1);
    border: 1px solid rgba(0, 184, 148, 0.2);
    font-size: 11px;
    color: var(--green);
    font-weight: 500;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .chart-row { grid-template-columns: 1fr; }
    .container { padding: 16px; }
    .header { padding: 16px; }
  }

  /* Loading */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    color: var(--text-dim);
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  .loading span { animation: pulse 1.5s ease-in-out infinite; }

  /* Refresh button */
  .refresh-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }
  .refresh-btn:hover {
    background: var(--border);
    color: var(--text);
  }
</style>
</head>
<body>

<div class="header">
  <h1><span>Claude-Saver</span> Dashboard</h1>
  <div class="header-meta">
    <span class="privacy-badge">All data stays local</span>
    <span><span class="status-dot live" id="statusDot"></span><span id="statusText">Live</span></span>
    <button class="refresh-btn" onclick="refresh()">Refresh</button>
  </div>
</div>

<div class="container" id="app">
  <div class="loading"><span>Loading metrics...</span></div>
</div>

<script>
const API = window.location.origin;

function fmt(n) {
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return String(Math.round(n));
}

function fmtCost(n) {
  return (n >= 0 ? '' : '-') + '$' + Math.abs(n).toFixed(2);
}

function fmtDuration(ms) {
  if (ms >= 60000) return (ms / 60000).toFixed(1) + 'm';
  if (ms >= 1000) return (ms / 1000).toFixed(1) + 's';
  return ms + 'ms';
}

function timeAgo(ts) {
  const diff = Date.now() - new Date(ts).getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  return Math.floor(diff / 86400000) + 'd ago';
}

let savingsChart, splitChart, toolsChart;

function destroyCharts() {
  [savingsChart, splitChart, toolsChart].forEach(c => c?.destroy());
}

function renderDashboard(data) {
  const app = document.getElementById('app');

  if (data.local_tasks === 0) {
    app.innerHTML = `
      <div class="empty-state">
        <h2>No delegations yet</h2>
        <p>Start using Claude-Saver tools to see your savings here.</p>
        <p style="margin-top:16px;font-size:13px">
          Try asking Claude to delegate a task locally, or set delegation level 2+.
        </p>
      </div>`;
    return;
  }

  const netClass = data.net_cost >= 0 ? 'positive' : 'negative';
  const efficiency = data.total_local_tokens > 0
    ? Math.round(((data.total_local_tokens - data.total_cloud_overhead) / data.total_local_tokens) * 100)
    : 0;

  app.innerHTML = `
    <div class="kpi-grid">
      <div class="kpi">
        <div class="kpi-label">Net Saved</div>
        <div class="kpi-value ${netClass}">${fmtCost(data.net_cost)}</div>
        <div class="kpi-sub">After ${fmtCost(data.overhead_cost)} wrapper overhead</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Local Tokens</div>
        <div class="kpi-value neutral">${fmt(data.total_local_tokens)}</div>
        <div class="kpi-sub">${fmt(data.net_tokens_saved)} net (minus overhead)</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Delegations</div>
        <div class="kpi-value">${data.local_tasks}</div>
        <div class="kpi-sub">Across ${data.sessions} session${data.sessions !== 1 ? 's' : ''}</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Efficiency</div>
        <div class="kpi-value ${efficiency >= 50 ? 'positive' : efficiency >= 0 ? 'warn' : 'negative'}">${efficiency}%</div>
        <div class="kpi-sub">Token savings vs overhead</div>
      </div>
    </div>

    <div class="chart-full card">
      <div class="card-title">Savings Over Time</div>
      <div class="chart-container tall"><canvas id="savingsChart"></canvas></div>
    </div>

    <div class="chart-row">
      <div class="card">
        <div class="card-title">Token Split</div>
        <div class="chart-container"><canvas id="splitChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Tool Usage</div>
        <div class="chart-container"><canvas id="toolsChart"></canvas></div>
      </div>
    </div>

    <div class="card" style="margin-bottom:24px">
      <div class="card-title">Recent Delegations</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>When</th><th>Tool</th><th>Model</th><th>Local Tokens</th><th>Overhead</th><th>Net</th><th>Duration</th></tr>
          </thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>
    </div>
  `;

  renderCharts(data);
  renderTable(data.recent);
}

function renderCharts(data) {
  destroyCharts();

  const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { labels: { color: '#8b90a5', font: { size: 11 } } },
    },
  };

  // Savings timeline
  const ctx1 = document.getElementById('savingsChart').getContext('2d');
  savingsChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: data.timeline.map(d => d.date),
      datasets: [
        {
          label: 'Local Tokens',
          data: data.timeline.map(d => d.tokens),
          borderColor: '#6c5ce7',
          backgroundColor: 'rgba(108, 92, 231, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
        },
        {
          label: 'Overhead',
          data: data.timeline.map(d => d.overhead),
          borderColor: '#e17055',
          backgroundColor: 'rgba(225, 112, 85, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
        },
      ],
    },
    options: {
      ...chartDefaults,
      scales: {
        x: { ticks: { color: '#8b90a5', font: { size: 11 } }, grid: { color: '#2e3345' } },
        y: { ticks: { color: '#8b90a5', font: { size: 11 }, callback: v => fmt(v) }, grid: { color: '#2e3345' } },
      },
    },
  });

  // Token split donut
  const ctx2 = document.getElementById('splitChart').getContext('2d');
  splitChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ['Net Local Savings', 'Wrapper Overhead'],
      datasets: [{
        data: [Math.max(0, data.net_tokens_saved), data.total_cloud_overhead],
        backgroundColor: ['#00b894', '#e17055'],
        borderWidth: 0,
      }],
    },
    options: {
      ...chartDefaults,
      cutout: '65%',
      plugins: {
        ...chartDefaults.plugins,
        legend: { position: 'bottom', labels: { color: '#8b90a5', font: { size: 12 }, padding: 16 } },
      },
    },
  });

  // Tool usage bar chart
  const ctx3 = document.getElementById('toolsChart').getContext('2d');
  const toolEntries = Object.entries(data.tools).sort((a, b) => b[1] - a[1]);
  const toolColors = ['#6c5ce7', '#74b9ff', '#00b894', '#fdcb6e', '#e17055', '#a29bfe'];
  toolsChart = new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: toolEntries.map(([name]) => name.replace('claudesaver_', '')),
      datasets: [{
        label: 'Calls',
        data: toolEntries.map(([, count]) => count),
        backgroundColor: toolEntries.map((_, i) => toolColors[i % toolColors.length]),
        borderRadius: 6,
        borderSkipped: false,
      }],
    },
    options: {
      ...chartDefaults,
      indexAxis: 'y',
      plugins: { ...chartDefaults.plugins, legend: { display: false } },
      scales: {
        x: { ticks: { color: '#8b90a5' }, grid: { color: '#2e3345' } },
        y: { ticks: { color: '#8b90a5', font: { size: 11 } }, grid: { display: false } },
      },
    },
  });
}

function renderTable(recent) {
  const body = document.getElementById('recentBody');
  if (!body) return;

  body.innerHTML = recent.slice(0, 20).map(r => {
    const net = r.tokens - r.overhead;
    const netClass = net >= 0 ? 'positive-cell' : 'negative-cell';
    return `<tr>
      <td>${timeAgo(r.timestamp)}</td>
      <td><span class="tag tag-tool">${r.tool.replace('claudesaver_', '')}</span></td>
      <td><span class="tag tag-model">${r.model.length > 20 ? r.model.slice(0, 20) + '...' : r.model}</span></td>
      <td>${fmt(r.tokens)}</td>
      <td>${fmt(r.overhead)}</td>
      <td class="${netClass}">${net >= 0 ? '+' : ''}${fmt(net)}</td>
      <td>${fmtDuration(r.duration_ms)}</td>
    </tr>`;
  }).join('');
}

async function refresh() {
  try {
    const res = await fetch(API + '/api/data');
    const data = await res.json();
    renderDashboard(data);
    document.getElementById('statusDot').className = 'status-dot live';
    document.getElementById('statusText').textContent = 'Live';
  } catch (e) {
    document.getElementById('statusDot').className = 'status-dot off';
    document.getElementById('statusText').textContent = 'Error';
  }
}

// Initial load
refresh();
// Auto-refresh every 10s
setInterval(refresh, 10000);
</script>
</body>
</html>
